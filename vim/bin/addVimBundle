#!/usr/bin/env python

import argparse
import os
import re
import subprocess
import sys

parser = argparse.ArgumentParser(description='Script to add a Pathogen bundle to my Vim config')
parser.add_argument('githubURL', help='either Github repo URL or clone URL for Github repo')

args = parser.parse_args()
url = args.githubURL

match = re.match(r'.*[\/:](.*?)\/([^\.]*)(?:\.git)?', url)
if not match:
    print 'Could not parse github URL'
    sys.exit(1)

githubName = match.group(1)
bundleName = match.group(2)

try:
    os.chdir(os.path.expanduser('~/dotfiles'))
except OSError:
    print 'Could not find ~/dotfiles'
    sys.exit(1)

newURL = 'git@github.com:{}/{}.git'.format(githubName, bundleName)

# stash current changes
subprocess.call([
    'git',
    'stash'
    ])

# add the submodule
subprocess.call([
    'git',
    'submodule',
    'add',
    '--force',
    newURL,
    'vim/bundle/{}'.format(bundleName)
    ])

# commit changes to .gitmodules and new submodule
subprocess.call([
    'git',
    'commit',
    '-m',
    'added submodule: {}'.format(bundleName)
    ])

# unstash changes
subprocess.call([
    'git',
    'stash',
    'pop'
    ])
